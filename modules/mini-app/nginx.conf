# /etc/nginx/conf.d/default.conf
# This example uses placeholders for your environment variables,
# which you might fill in via envsubst or Docker.

server {
    listen ${VITE_SERVER_PORT};  # e.g., 80
    server_name ${VITE_SERVER_NAME};  # e.g., tonaffiliates.com

    # Serve the front-end app
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri /index.html;

        # Basic CORS for SPA if needed
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $host;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";
            return 204;
        }
    }

    location /assets/ {
        root /usr/share/nginx/html;
        add_header Access-Control-Allow-Origin $host;
    }

    # Proxy API requests to your Node server
    location /api/ {
        proxy_pass ${BACKEND_URL};  # e.g. http://web-server:3000
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

        # Add CORS if needed
        add_header Access-Control-Allow-Origin $host;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";

        # Static JWT header example:
        proxy_set_header X-Proxy-Authorization "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJuZ2lueC1zdGF0aWMiLCJpYXQiOjE3Mzc4OTYxMzMsImV4cCI6MTc2OTQzMjEzM30.d8KzOPH8ofibZk_ZvBayEsfIiQog6QEcpFl5WrdUoPk";

        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Dedicated SSE endpoint (for example, /api/sse)
    location /api/sse {
        # Note: This block is for SSE and should not set the upgrade headers.
        proxy_pass ${BACKEND_URL}/api/sse;  # Ensure your Node server exposes the SSE endpoint at /api/sse.
        proxy_set_header Host $host;

        # Disable proxy buffering to send events immediately.
        proxy_buffering off;
        proxy_cache off;
        add_header Cache-Control no-cache;
        
        # Optional: increase proxy_read_timeout if needed.
        proxy_read_timeout 3600;
    }

    error_page 403 /403.html;
}
